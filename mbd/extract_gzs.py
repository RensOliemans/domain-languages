from pyspark import SparkContext
from pyspark.sql import SparkSession

import pyspark.sql.functions as F
from pyspark.sql.types import *

LANGUAGE = 'fr'


APPNAME = 'Filter URLs'
sc = SparkContext(appName=APPNAME)
sc.setLogLevel('ERROR')
spark = SparkSession.builder.appName(APPNAME).getOrCreate()


def convert_to_tld( entry):
    parts = entry.split(',')
    return parts[0]


def strip_dq(entry):
    if entry:
        return entry.replace('"', '')
    return entry


udf_tld = F.udf(convert_to_tld, StringType())
udf_strip_dq = F.udf(strip_dq, StringType())


MAPPING = {
    '2020-50': {
        'fr': ['00190', '00191', '00192', '00193', '00194'],
        'se': ['00277', '00278', '00279'],
        'de': ['00168', '00169', '00170', '00171', '00172', '00173', '00174', '00175', '00176', '00177', '00178'],
        'it': ['00206', '00207', '00208', '00209', '00210', '00211'],
        'ru': ['00263', '00264', '00265', '00266', '00267', '00268', '00269', '00270', '00271', '00272', '00273',
               '00274', '00275', '00276', '00277'],
        'gr': ['00197', '00198'],
        'uk': ['00289', '00290', '00291', '00292', '00293', '00294', '00295'],
        'es': ['00184', '00185', '00186', '00187'],
    },
    '2020-24': {
        'fr': ['00190', '00191', '00192', '00193', '00194', '00195'],
        'se': ['00279', '00280', '00281'],
        'de': ['00169', '00170', '00171', '00172', '00173', '00174', '00175', '00176', '00177', '00178', '00179',
               '00180'],
        'it': ['00208', '00209', '00210', '00211', '00212', '00213'],
        'ru': ['00266', '00267', '00268', '00269', '00270', '00271', '00272', '00273', '00274', '00275', '00276',
               '00277', '00278', '00279'],
        'gr': ['00197', '00198'],
        'uk': ['00290', '00291', '00292', '00293', '00294', '00295', '00296'],
        'es': ['00184', '00185', '00186', '00187'],
    },
    '2019-47': {
        'fr': ['00197', '00198', '00199', '00200'],
        'se': ['00280', '00281', '00282'],
        'de': ['00177', '00178', '00179', '00180', '00181', '00182', '00183', '00184', '00185', '00186'],
        'it': ['00213', '00214', '00215', '00216', '00217'],
        'ru': ['00269', '00270', '00271', '00272', '00273', '00274', '00275', '00276', '00277', '00278', '00279',
               '00280'],
        'gr': ['00203'],
        'uk': ['00290', '00291', '00292', '00293', '00294', '00295', '00296'],
        'es': ['00191', '00192', '00193', '00194'],
    },
    '2019-22': {
        'fr': ['00187', '00188', '00189', '00190', '00191', '00192', '00193'],
        'se': ['00279', '00280', '00281'],
        'de': ['00165', '00166', '00167', '00168', '00169', '00170', '00171', '00172', '00173', '00174', '00175',
               '00176', '00177'],
        'it': ['00205', '00206', '00207', '00208', '00209', '00210'],
        'ru': ['00264', '00265', '00266', '00267', '00268', '00269', '00270', '00271', '00272', '00273', '00274',
               '00275', '00276', '00277', '00278', '00279'],
        'gr': ['00194', '00195'],
        'uk': ['00289', '00290', '00291', '00292', '00293', '00294', '00295', '00296'],
        'es': ['00181', '00182', '00183', '00184'],
    },
    '2018-47': {
        'fr': ['00182', '00183', '00184', '00185', '00186', '00187'],
        'se': ['00277', '00278', '00279'],
        'de': ['00163', '00164', '00165', '00166', '00167', '00168', '00169', '00170', '00171', '00172', '00173'],
        'it': ['00200', '00201', '00202', '00203', '00204'],
        'ru': ['00258', '00259', '00260', '00261', '00262', '00263', '00264', '00265', '00266', '00267', '00268',
               '00269', '00270', '00271', '00272', '00273', '00274', '00275', '00276', '00277'],
        'gr': ['00188', '00189'],
        'uk': ['00288', '00289', '00290', '00291', '00292', '00293', '00294', '00295'],
        'es': ['00177', '00178', '00179'],
    },
    '2018-22': {
        'fr': ['00194', '00195', '00196', '00197', '00198'],
        'se': ['00279', '00280', '00281'],
        'de': ['00175', '00176', '00177', '00178', '00179', '00180', '00181', '00182', '00183', '00184', '00185',
               '00186'],
        'it': ['00209', '00210', '00211', '00212'],
        'ru': ['00263', '00264', '00265', '00266', '00267', '00268', '00269', '00270', '00271', '00272', '00273',
               '00274', '00275', '00276', '00277', '00278', '00279'],
        'gr': ['00199', '00200'],
        'uk': ['00288', '00289', '00290', '00291', '00292', '00293', '00294', '00295'],
        'es': ['00190', '00191', '00192'],
    },
    '2017-47': {
        'fr': ['00198', '00199', '00200', '00201', '00202'],
        'se': ['00281', '00282', '00283'],
        'de': ['00180', '00181', '00182', '00183', '00184', '00185', '00186', '00187', '00188', '00189'],
        'it': ['00211', '00212', '00213', '00214', '00215'],
        'ru': ['00265', '00266', '00267', '00268', '00269', '00270', '00271', '00272', '00273', '00274', '00275',
               '00276', '00277', '00278', '00279', '00280', '00281'],
        'gr': ['00203', '00204'],
        'uk': ['00290', '00291', '00292', '00293', '00294', '00295', '00296', '00297'],
        'es': ['00193', '00194', '00195', '00196'],
    },
    '2017-22': {
        'fr': ['00203', '00204', '00205', '00206'],
        'se': ['00283', '00284'],
        'de': ['00187', '00188', '00189', '00190', '00191', '00192', '00193', '00194', '00195'],
        'it': ['00215', '00216', '00217', '00218', '00219'],
        'ru': ['00267', '00268', '00269', '00270', '00271', '00272', '00273', '00274', '00275', '00276', '00277',
               '00278', '00279', '00280', '00281', '00282', '00283'],
        'gr': ['00208', '00209'],
        'uk': ['00291', '00292', '00293', '00294', '00295', '00296', '00297'],
        'es': ['00199', '00200', '00201'],
    },
    '2016-44': {
        'fr': ['00199', '00200', '00201', '00202'],
        'se': ['00283', '00284'],
        'de': ['00181', '00182', '00183', '00184', '00185', '00186', '00187', '00188', '00189', '00190'],
        'it': ['00212', '00213', '00214', '00215'],
        'ru': ['00265', '00266', '00267', '00268', '00269', '00270', '00271', '00272', '00273', '00274', '00275',
               '00276', '00277', '00278', '00279', '00280', '00281', '00282', '00283'],
        'gr': ['00205'],
        'uk': ['00291', '00292', '00293', '00294', '00295', '00296', '00297'],
        'es': ['00195', '00196', '00197'],
    },
    '2016-22': {
        'fr': ['00236', '00237'],
        'se': ['00291'],
        'de': ['00221', '00222', '00223', '00224'],
        'it': ['00244', '00245'],
        'ru': ['00291'],
        'gr': ['00242'],
        'uk': ['00292', '00293', '00294', '00295', '00296', '00297', '00298'],
        'es': ['00235', '00236'],
    }
}


raw_instances = ['2020-50']

for instance in raw_instances:
    print('Using instance %s' % instance)
    relevant_files = MAPPING[instance][LANGUAGE]
    relevant_files = ['gzs/CC-MAIN-{}'.format(i) for i in relevant_files]
    print(relevant_files)

    # Load CSV
    df = spark.read.csv(*relevant_files, sep=' ').repartition(100)

    # Take relevant columns and rename
    df = df.select('_c0', '_c13', '_c15', '_c17') \
        .withColumnRenamed('_c0', 'urlinfo') \
        .withColumnRenamed('_c13', 'length') \
        .withColumnRenamed('_c15', 'offset') \
        .withColumnRenamed('_c17', 'filename')

    # Filter null values
    df = df.na.drop()

    # Filter language
    df = df.filter((df.urlinfo.startswith('{},'.format(LANGUAGE))))

    # Strip double quotes
    df = df \
        .withColumn('length', udf_strip_dq(df.length)) \
        .withColumn('offset', udf_strip_dq(df.offset)) \
        .withColumn('filename', udf_strip_dq(df.filename))

    # Keep only tld
    df = df \
        .withColumn('urlinfo', udf_tld(df.urlinfo)) \
        .withColumnRenamed('urlinfo', 'tld')

    # df = df.sample(0.01)
    df.write.format('parquet').mode('overwrite').option('header', 'true').csv('warc-locations/{}-{}'.format(instance.split('/')[1], LANGUAGE))

